name: Build Swift Playgrounds App

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest
    env:
      APP_NAME: ChatZEUS   # غيّر هنا إذا كان اسم bundle مختلفًا
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '16.4'

      - name: Unzip Project
        run: unzip ChatZEUS.zip

      - name: Show available schemes (verify)
        run: |
          if [ -d "ChatZEUS.swiftpm" ]; then
            cd ChatZEUS.swiftpm
            echo "داخل مجلد ChatZEUS.swiftpm — أظهر الـ schemes المتاحة:"
            xcodebuild -list || true
            cd ..
          else
            echo "لم أجد مجلد ChatZEUS.swiftpm؛ أدرج محتويات المستودع:"
            ls -la
            exit 1
          fi

      - name: Build and Archive
        run: |
          APP_NAME="${APP_NAME:-ChatZEUS}"
          if [ -d "ChatZEUS.swiftpm" ]; then
            cd ChatZEUS.swiftpm
            mkdir -p ../build
            echo "بادئ البناء والأرشفة للاسم: $APP_NAME"
            xcodebuild -scheme "$APP_NAME" \
                       -destination 'generic/platform=iOS' \
                       -sdk iphoneos \
                       -configuration Release \
                       -archivePath ../build/"$APP_NAME".xcarchive \
                       archive \
                       CODE_SIGN_IDENTITY="" CODE_SIGNING_REQUIRED=NO CODE_SIGNING_ALLOWED=NO
            cd ..
          else
            echo "لا يمكن البناء: لم أجد مجلد ChatZEUS.swiftpm"
            exit 1
          fi

      - name: Show archive contents (debug)
        run: |
          APP_NAME="${APP_NAME:-ChatZEUS}"
          ARCHIVE="build/$APP_NAME.xcarchive"
          echo "تفاصيل الأرشيف (إن وجدت): $ARCHIVE"
          if [ -d "$ARCHIVE" ]; then
            ls -la "$ARCHIVE"
            echo "داخل Products/Applications:"
            ls -la "$ARCHIVE/Products/Applications" || true
          else
            echo "الأرشيف غير موجود."
          fi

      - name: Create unsigned IPA (for signing later with ksign)
        run: |
          APP_NAME="${APP_NAME:-ChatZEUS}"
          ARCHIVE="build/$APP_NAME.xcarchive"
          APP_PATH="$ARCHIVE/Products/Applications/$APP_NAME.app"

          if [ -d "$APP_PATH" ]; then
            echo "وجدت التطبيق داخل الأرشيف: $APP_PATH"
            rm -rf build/Payload
            mkdir -p build/Payload
            cp -R "$APP_PATH" build/Payload/
            # أنشئ ملف ipa غير موقّع
            (cd build && zip -r "${APP_NAME}-unsigned.ipa" Payload)
            echo "تم إنشاء build/${APP_NAME}-unsigned.ipa"
            ls -la build/*.ipa || true
          else
            echo "خطأ: لم أجد التطبيق داخل الأرشيف: $APP_PATH"
            echo "تفاصيل الأرشيف:"
            ls -la "$ARCHIVE" || true
            exit 1
          fi

      - name: Upload IPA Artifact
        uses: actions/upload-artifact@v4
        with:
          name: ChatZEUS-IPA
          path: build/*.ipa